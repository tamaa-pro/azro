<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>صفحة تحميل المجلد من GitHub</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .file-list { max-height: 300px; overflow-y: auto; }
    .file-item { margin: 0.2rem 0; }
    .buttons { display: flex; gap: 0.5rem; }
  </style>
</head>
<body>
  <h1>تحميل المجلد من GitHub</h1>

  <div id="infoCard" class="card">
    <h2>محتويات المجلد</h2>
    <div id="fileList" class="file-list">جار تحميل...</div>
  </div>

  <div id="actionsCard" class="card">
    <div class="buttons">
      <button id="btnDownload">تحميل ZIP</button>
      <button id="btnOpen">فتح في GitHub</button>
      <button id="btnCopy">نسخ الرابط</button>
      <button id="btnShare">مشاركة</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    async function main() {
      const params = new URLSearchParams(window.location.search);
      const target = params.toString(); // كل ما بعد "?"
      if (!target) {
        document.getElementById("fileList").innerText = "لم يُقدَّم رابط.";
        return;
      }
      // نسمح أن يكون الرابط كاملاً بعد ?
      const url = decodeURIComponent(target);
      // تحديد owner, repo, path من رابط مثل:
      // https://github.com/owner/repo/tree/branch/path/to/folder
      const m = url.match(/github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/tree\\/([^\\/]+)\\/(.+)$/);
      if (!m) {
        document.getElementById("fileList").innerText = "الرابط غير مطابق لنمط مجلد GitHub.";
        return;
      }
      const owner = m[1], repo = m[2], branch = m[3], path = m[4];
      const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
      // جلب الملفات (واجهة GitHub)
      let allFiles = [];
      async function fetchDir(apiUrl, subPath = "") {
        const resp = await fetch(apiUrl);
        if (!resp.ok) {
          throw new Error("فشل جلب المحتوى: " + resp.status);
        }
        const items = await resp.json();
        for (const item of items) {
          if (item.type === "file") {
            allFiles.push({ path: (subPath ? subPath + "/" : "") + item.name, download_url: item.download_url });
          } else if (item.type === "dir") {
            // استدعاء تكراري
            await fetchDir(`https://api.github.com/repos/${owner}/${repo}/contents/${path}/${(subPath ? subPath + "/" : "") + item.name}?ref=${branch}`, (subPath ? subPath + "/" : "") + item.name);
          }
        }
      }
      try {
        await fetchDir(apiBase);
      } catch (e) {
        document.getElementById("fileList").innerText = "حدث خطأ: " + e.message;
        console.error(e);
        return;
      }
      // عرض القائمة
      const fl = document.getElementById("fileList");
      fl.innerHTML = "";
      allFiles.forEach(f => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.textContent = f.path;
        fl.append(div);
      });

      // ربط الأزرار
      document.getElementById("btnOpen").onclick = () => {
        window.open(url, "_blank");
      };
      document.getElementById("btnCopy").onclick = () => {
        navigator.clipboard.writeText(url);
        alert("تم نسخ الرابط");
      };
      document.getElementById("btnShare").onclick = () => {
        // يمكن تخصيص المشاركة حسب الحاجة
        const shareUrl = window.location.href;
        prompt("شارك هذا الرابط:", shareUrl);
      };
      document.getElementById("btnDownload").onclick = async () => {
        const zip = new JSZip();
        for (const f of allFiles) {
          const r = await fetch(f.download_url);
          if (!r.ok) {
            console.error("فشل تحميل الملف:", f.download_url);
            continue;
          }
          const blob = await r.blob();
          zip.file(f.path, blob);
        }
        const content = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = `${repo}-${path.replace(/\//g, "_")}.zip`;
        a.click();
      };
    }

    main();
  </script>
</body>
</html>
