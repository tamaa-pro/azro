<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تحميل التطبيق</title>
<style>
body{background:#111;color:#eee;font-family:sans-serif;margin:0;padding:20px}
.container{max-width:900px;margin:auto}
h1{text-align:center;margin-bottom:20px}
.app-header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
.app-header img{width:80px;height:80px;border-radius:20px;object-fit:cover}
button{padding:10px 20px;background:#4caf50;border:none;border-radius:10px;color:#fff;font-size:16px;cursor:pointer}
button:hover{background:#45a049}
.screenshots{display:flex;gap:10px;flex-wrap:wrap;margin:20px 0}
.screenshots img{max-width:200px;border-radius:10px;border:1px solid #333}
.socials a{color:#4da6ff;display:block;margin:5px 0;text-decoration:none}
.note{background:#222;padding:5px 10px;font-size:12px;color:#aaa;border-radius:6px;margin-top:5px}
.counter{text-align:right;margin-top:10px;color:#aaa}
</style>
</head>
<body>
<div class="container">
<div id="appContent"></div>
</div>

<script>
const mainBin="https://api.jsonbin.io/v3/b/68b5a02ed0ea881f406e0b94";
const downloadsBin="https://api.jsonbin.io/v3/b/68b73b75d0ea881f406fa775";
const apiKey="$2a$10$F5TR7pSKPRRNAeBzsdxQ4.NYog8xHGUi0hektkor0q/QWFVXzba3q";

function getPackageFromUrl(){const q=window.location.search;return q.startsWith("?")?q.substring(1):null}

async function fetchBin(url){const res=await fetch(url,{headers:{"X-Master-Key":apiKey}});return res.json()}

async function updateDownloads(pkg){const d=await fetchBin(downloadsBin);let record=d.record.applications_downloads;if(!record[pkg]&&record[pkg]!==0)record[pkg]=0;record[pkg]++;await fetch(downloadsBin,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":apiKey},body:JSON.stringify({applications_downloads:record})});return record[pkg]}

async function loadApp(){
const pkg=getPackageFromUrl();if(!pkg){document.getElementById("appContent").innerHTML="<p>❌ لم يتم تحديد التطبيق</p>";return}
try{
const data=await fetchBin(mainBin);const apps=data.record.applications;
const app=apps.find(a=>a.package===pkg);
if(!app){document.getElementById("appContent").innerHTML="<p>❌ التطبيق غير موجود</p>";return}

const dData=await fetchBin(downloadsBin);let downloads=dData.record.applications_downloads[pkg]||0;

document.getElementById("appContent").innerHTML=`
<div class="app-header">
<img src="${app.icon}" alt="icon">
<div>
<h1>${app.name}</h1>
<p>الإصدار: ${app.version} | ${app.releaseDate}</p>
<p>المطور: ${app.developer}</p>
</div>
</div>
<p>${app.longDesc}</p>
<div class="screenshots">
${app.screenshots.map(s=>`<img src="${s}">`).join("")}
</div>
${app.extraInfo?`<div class="note">${app.extraInfo}</div>`:""}
${app.social&&app.social.length?`<div class="socials">${app.social.map(s=>`<a href="${s}" target="_blank">${s}</a>`).join("")}</div>`:""}
<div class="counter">عدد التحميلات: <span id="dlCount">${downloads}</span></div>
<button id="downloadBtn">⬇ تحميل</button>
`;

document.getElementById("downloadBtn").addEventListener("click",async()=>{
const newCount=await updateDownloads(pkg);
document.getElementById("dlCount").textContent=newCount;
window.location.href=app.download;
});
}catch(err){document.getElementById("appContent").innerHTML="<p>❌ خطأ في جلب البيانات</p>"}
}
loadApp();
</script>
</body>
</html>
