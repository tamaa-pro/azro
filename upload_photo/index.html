<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>رفع صورة - اختبار</title>
<style>
  :root{--bg:#0b0b0d;--card:#111;--muted:#bfbfbf;--accent:#0a84ff;--ok:#2db34a;--err:#e03a3a}
  *{box-sizing:border-box}
  body{background:var(--bg);color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;padding:28px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:520px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
  h2{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:10px;align-items:center}
  input[type="file"]{padding:8px;background:#0f0f10;color:var(--muted);border-radius:8px;border:1px solid #222}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  #preview{display:block;margin:12px auto;border-radius:10px;max-width:100%;max-height:320px}
  #linkBox{margin-top:12px;padding:10px;background:#0b0b0b;border-radius:8px;color:var(--muted);word-break:break-all}
  .small{font-size:13px;color:var(--muted)}
  /* toast */
  .toast{position:fixed;left:50%;bottom:-90px;transform:translateX(-50%);min-width:200px;padding:12px 18px;border-radius:10px;color:#fff;transition:all .35s;box-shadow:0 8px 24px rgba(0,0,0,.6)}
  .toast.show{bottom:30px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>رفع صورة إلى Top4Top (اختبار)</h2>
      <div class="small">اختر صورة ثم اضغط رفع. ستظهر رسالة بالنتيجة ورابط الصورة إن نجح.</div>
      <div style="margin-top:12px" class="row">
        <input id="fileInput" type="file" accept="image/*">
        <button id="uploadBtn" onclick="startUpload()" disabled>رفع</button>
      </div>

      <img id="preview" style="display:none" alt="معاينة الصورة">

      <div id="status" class="small" style="margin-top:10px"></div>

      <div id="linkBox" style="display:none"></div>
    </div>
  </div>

  <div id="toast" class="toast" style="background:#333">..</div>

<script>
const WORKER_URL = "https://top4top-api.tamaa-production-studios.workers.dev"; // غيّر إن لزم
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const preview = document.getElementById("preview");
const statusEl = document.getElementById("status");
const linkBox = document.getElementById("linkBox");
const toast = document.getElementById("toast");

function showToast(msg, ok=true) {
  toast.textContent = msg;
  toast.style.background = ok ? "linear-gradient(90deg,#2db34a,#1e8f3a)" : "linear-gradient(90deg,#e03a3a,#b02a2a)";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 3200);
}

fileInput.addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) { preview.style.display = "none"; uploadBtn.disabled = true; return; }
  uploadBtn.disabled = false;
  const reader = new FileReader();
  reader.onload = ev => {
    preview.src = ev.target.result;
    preview.style.display = "block";
  };
  reader.readAsDataURL(f);
});

async function startUpload() {
  const f = fileInput.files[0];
  if (!f) { showToast("اختر صورة أولاً", false); return; }

  uploadBtn.disabled = true;
  statusEl.textContent = "جاري رفع الصورة..."; linkBox.style.display = "none"; linkBox.textContent = "";

  const token = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36);
  const form = new FormData();
  form.append("file", f);
  form.append("token", token);

  try {
    const res = await fetch(WORKER_URL, { method: "POST", body: form });
    let payload = null;
    try { payload = await res.json(); } catch(e) { payload = { success:false, code:"INVALID_RESPONSE", message:"استجابة غير قابلة للقراءة", http:res.status }; }

    // عرض مفصّل
    if (payload && payload.success) {
      statusEl.textContent = "تم الرفع بنجاح";
      linkBox.style.display = "block";
      linkBox.innerHTML = `<a href="${payload.url}" target="_blank" style="color:#0aa">${payload.url}</a>`;
      showToast("تم الرفع ✅", true);
    } else {
      const code = payload && payload.code ? payload.code : ("HTTP_" + (res.status || "ERR"));
      const msg = payload && payload.message ? payload.message : "فشل أثناء الرفع";
      statusEl.textContent = `${code} — ${msg}`;
      showToast(`${code}: ${msg}`, false);
      // للمطوّرين: عرض نص الاستجابة كاملاً في console
      console.warn("Upload failed:", payload, "httpStatus", res.status);
    }
  } catch (err) {
    statusEl.textContent = "خطأ أثناء إرسال الطلب";
    showToast("خطأ في الاتصال أو استجابة الخادم", false);
    console.error(err);
  } finally {
    uploadBtn.disabled = false;
  }
}
</script>
</body>
</html>
